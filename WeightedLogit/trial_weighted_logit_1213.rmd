---
title: "weighted_logistic regression"
author: "Yiwen Chen"
date: "2021/12/12"
output: pdf_document
---

```{r}
library(tidyverse)
library(srvyr)
library(survey)
library(svyVGAM)
full <- read.csv("adult20.csv")
```


# For each of the imputed value

# adding the survey-related variables back to the dataset to be used

```{r}
imputed1 <- read.csv("imputed dataset/imp_data1.csv")
imputed1$HHX <- full$HHX
imputed1$WTFA_A <- full$WTFA_A
imputed1$PSTRAT <- full$PSTRAT
imputed1$PPSU <- full$PPSU
```

```{r}
imputed1_new <- imputed1 %>% select(
  ##survey design
  HHX, WTFA_A, URBRRL, REGION, PSTRAT, PPSU,
  ## outcome
  MHRX_A, MHTHRPY_A, # mental health
  DEPEV_A, DEPFREQ_A, DEPMED_A, # depression
  ANXEV_A, ANXFREQ_A, ANXMED_A, # anxiety
  ##predictors, contain the imputed values
  CVDDIAG_A, COVIDTEST_A, 
  DLYCARE_A, DNGCARE_A, VIRAPP12M_A, 
  HOMECAREDG_A, FAMCAREDNG_A, 
  ##confounders ## no NAs
  AGEP_A, SEX_A, EDUC_A, 
  HISPALLP_A# r/e
  )

# recode yes/no data
binary_var <- c("MHRX_A", "MHTHRPY_A", "DEPEV_A", "DEPMED_A", "ANXEV_A", "ANXMED_A", "CVDDIAG_A", "COVIDTEST_A", "DLYCARE_A", "DNGCARE_A", "VIRAPP12M_A", "HOMECAREDG_A", "FAMCAREDNG_A")
for (i in binary_var){
  imputed1_new[,i] <- ifelse(imputed1_new[,i]>=7,NA,imputed1_new[,i])
  imputed1_new[,i] <- ifelse(is.na(imputed1_new[,i]),'Unknown',imputed1_new[,i])
  imputed1_new[,i] <- dplyr::recode(as.character(imputed1_new[,i]),
                                '1'='Yes','2'='No')
  imputed1_new[,i] <- factor(imputed1_new[,i],levels=c('No','Yes','Unknown'))
}

# recode frequency data
for (i in c('DEPFREQ_A','ANXFREQ_A')){
  imputed1_new[,i] <- ifelse(imputed1_new[,i]>=7,NA,imputed1_new[,i])
  imputed1_new[,i] <- dplyr::recode(as.character(imputed1_new[,i]),
                                '1'='Daily','2'='Weekly','3'='Monthly',
                                '4'='A few times a year','5'='Never')
  imputed1_new[,i] <- factor(imputed1_new[,i],levels=c('Never','A few times a year','Monthly','Weekly','Daily'))
}

# recode others
imputed1_new[,'SEX_A'] <- dplyr::recode(as.character(imputed1_new[,'SEX_A']),
                                '1'='Male','2'='Female','7'='Refused or Unknown',
                                '8'='Refused or Unknown','9'='Refused or Unknown')
imputed1_new$EDUC_A <- ifelse(imputed1_new$EDUC_A<=11&imputed1_new$EDUC_A>=5,5,imputed1_new$EDUC_A)
imputed1_new$EDUC_A <- ifelse(imputed1_new$EDUC_A<=4,0,imputed1_new$EDUC_A)
imputed1_new$EDUC_A <- ifelse(imputed1_new$EDUC_A%in% c(0,5),imputed1_new$EDUC_A,"Unknown")
imputed1_new$EDUC_A <- dplyr::recode(as.character(imputed1_new$EDUC_A),
                                '0'='High School or Below','5'='College or Above')
imputed1_new$EDUC_A <- relevel(as.factor(imputed1_new$EDUC_A),ref='High School or Below')
imputed1_new$HISPALLP_A <- dplyr::recode(as.character(imputed1_new$HISPALLP_A),
                                '1'='Hispanic','2'='NH White',
                                '3'='Black/African American','4'='Asian',
                                '5'='AIAN and any other group','6'='AIAN and any other group',
                                '7'='Other single and multiple races',
                                '97'='Refused','98'='Not ascertained','99'='unknown')
imputed1_new$HISPALLP_A <- relevel(as.factor(imputed1_new$HISPALLP_A),ref="NH White")

## categorize age?? ('97'='Refused','98'='Not ascertained','99'='unknown')
summary(imputed1_new)
```

# Fit model for binary outcomes

```{r}
# Each time fitting a model, remove only its own unknown outcomes

for (i in binary_var[1:6]){
  imputed1_mhrx <- imputed1_new[imputed1_new[,i]!="Unknown",]
  design1mhrx <- imputed1_mhrx %>%
    as_survey_design( # might need to change based on our variable names and design
      ids = HHX,
      strata = PSTRAT,
      weights = WTFA_A,
      nest = TRUE
    )
  imputed1_mhrx[,i] <- as.integer(ifelse(imputed1_mhrx[,i]=='Yes',1,0))
  
  logit.formula <- as.formula(paste(i,'~CVDDIAG_A + COVIDTEST_A + DLYCARE_A + DNGCARE_A + VIRAPP12M_A + HOMECAREDG_A + FAMCAREDNG_A + AGEP_A + SEX_A + EDUC_A + HISPALLP_A',collapse=''))
  MHRX_A_imputed1_logit <- svyglm(
    logit.formula,
    family = quasibinomial(), 
    design = design1mhrx
  )
  print(i)
  print(summary(MHRX_A_imputed1_logit))
  }
```

# Fit model for multiple outcomes
## Not working corrrectly yet // or it just take a while to run idk

```{r}
# Each time fitting a model, remove only its own unknown outcomes

for (i in c('DEPFREQ_A','ANXFREQ_A')){
  imputed1_mhrx <- imputed1_new[!is.na(imputed1_new[,i]),]
  design1mhrx <- imputed1_mhrx %>%
    as_survey_design( # might need to change based on our variable names and design
      ids = HHX,
      strata = PSTRAT,
      weights = WTFA_A,
      nest = TRUE
    )
  imputed1_mhrx[,i] <- as.integer(imputed1_mhrx[,i])-1
  logit.formula <- as.formula(paste(i,'~CVDDIAG_A + COVIDTEST_A + DLYCARE_A + DNGCARE_A + VIRAPP12M_A + HOMECAREDG_A + FAMCAREDNG_A + AGEP_A + SEX_A + EDUC_A + HISPALLP_A',collapse=''))
  MHRX_A_imputed1_logit <- svy_vglm(
    logit.formula,
    family=multinomial, 
    design = design1mhrx
  )
  print(i)
  print(summary(MHRX_A_imputed1_logit))
  }
```

